<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <link href='lib/fullcalendar.min.css' rel='stylesheet' />
    <link href='lib/fullcalendar.print.min.css' rel='stylesheet' media='print' />
    <script src='lib/moment.min.js'></script>
    <script src='lib/jquery.min.js'></script>
    <script src='lib/fullcalendar.min.js'></script>
    <script src="https://www.gstatic.com/firebasejs/4.10.1/firebase.js"></script>
    <script>
        $(document).ready(function() {
            var config = {
                apiKey:"AIzaSyAn9cS4J2VMItPAG7DFDqRfgZfknrVjhQ8",
                databaseURL: "https://dydi-82330.firebaseio.com/",
            };
            firebase.initializeApp(config);

            var database = firebase.database();
            var taskRef = database.ref('task');
            var num = 0;
            var event;
            $('#calendar').fullCalendar('refetchEvents');
            $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,agendaDay,listWeek',
                },
                defaultDate: new Date(),
                navLinks: true, // can click day/week names to navigate views
                editable: true,
                eventLimit: true, // allow "more" link when too many events
                eventDrop: function (event, delta, revertFunc) {
                    var start = event.start.format().split(":")[0] + ":" + event.start.format().split(":")[1];
                    var end = event.end.format().split(":")[0] + ":" + event.end.format().split(":")[1];
                    if (confirm("Are you sure about this change?")) {
                            ///revertFunc();
                            var complete_;
                            if (event.backgroundColor == "pink"){
                                complete_ = "complete";
                            }
                            else if (event.backgroundColor == "skyblue") {
                                complete_ = "not yet";
                            }
                            else {
                                complete_ = "not needed";
                            }
                            var newobj = {
                                group : event.group,
                                complete: complete_,
                                end: end,
                                recurring: false,
                                start: start,
                                title : event.title,
                            }
                            taskRef.child(String(event.title)).set(newobj);
                            $('#calendar').fullCalendar('refetchEvents');
                            road();
                        }
                    else {
                        revertFunc();
                    }
                }
            });

            function find(a, b) {
                for (var j = 0; j < b.length; j++) {
                    if (a == b[j]){
                        return true;
                    }
                }
                return false;
            }

            function road() {
                taskRef.on('value', function (snapshot) {
                    $('#calendar').fullCalendar('removeEvents');
                    snapshot.forEach(function (childSnapshot) {
                        var range2;
                        var repeatlist = [];
                        var status = [];
                        var range = [];
                        var color = "black";
                        var backgroundcolor = "skyblue";
                        var border = "skyblue";
                        var startdate = String(childSnapshot.val().start.split("T")[0]);
                        var enddate = String(childSnapshot.val().end.split("T")[0]);
                        var starttime = String(childSnapshot.val().start.split("T")[1]);
                        var endtime = String(childSnapshot.val().end.split("T")[1]);
                        database.ref('task').child(childSnapshot.key).child("recurring").on('value', function (childchildsnapshot) {
                            childchildsnapshot.forEach(function(repeatsnapshot){
                                if (repeatsnapshot.val() == true) {
                                    repeatlist.push(repeatsnapshot.key);
                                }
                            })
                        });
                        database.ref('task').child(childSnapshot.key).child("status").on('value', function (childchildsnapshot) {
                            childchildsnapshot.forEach(function (repeatsnapshot) {
                                if (repeatsnapshot.val() == true) {
                                    status.push(repeatsnapshot.key);
                                }
                            })
                        });  

                        if (childSnapshot.val().recurring == false) {
                            event = {
                                id : childSnapshot.val().id,
                                title: childSnapshot.val().title,
                                start: childSnapshot.val().start,
                                end: childSnapshot.val().end,
                                dow : [],
                                allday: false,
                                textColor: color,
                                backgroundColor: backgroundcolor,
                                borderColor: border,
                            }
                            $('#calendar').fullCalendar('renderEvent', event, true);
                        }
                        else {
                            for (var i = moment(startdate) ; i.diff(moment(enddate)) < 0 ; i = i.add(1, 'days')) {
                                if (find(i.format('d'),repeatlist)) {
                                    if (find(i.format('YYYY-MM-DD'), status)) {
                                        backgroundcolor = "pink";
                                        border = "pink"
                                        color = "black";
                                    }
                                    else {
                                        color = "black";
                                        backgroundcolor = "skyblue";
                                        border = "skyblue";
                                    }
                                    event = {
                                        id: childSnapshot.val().id,
                                        title: childSnapshot.val().title,
                                        start: i.format('YYYY-MM-DD') + "T" + starttime,
                                        end: i.format('YYYY-MM-DD') + "T" + endtime,
                                        allday: false,
                                        textColor: color,
                                        backgroundColor: backgroundcolor,
                                        borderColor: border,
                                        editable : false,
                                    }
                                    $('#calendar').fullCalendar('renderEvent', event, true);
                                }
                            }
                        }
                    })
                })
            }

            //function reroad() {
            //    taskRef.on('value', function (snapshot) {
            //        snapshot.forEach(function (childSnapshot) {
            //            var date;
            //            var year;
            //            var month;
            //            var date2;
            //            var id = childSnapshot.val().id;
            //            if (!(childSnapshot.val().recurring == false)) {
            //                database.ref('task').child(childSnapshot.key).child("status").on('value', function (childchildsnapshot) {
            //                    childchildsnapshot.forEach(function (repeatsnapshot) {
            //                        date = repeatsnapshot.key;
            //                        //year = date.split("-")[0];
            //                        //month = date.split("-")[1];
            //                        //date2 = date.split("-")[2];
            //                        //if (Number(month) < 10) {
            //                        //    month = month.split("0")[1];
            //                        //}
            //                        //if (Number(date2) < 10) {
            //                        //    date2 = date2.split("0")[1];
            //                        //}
            //                         $('#calendar').fullCalendar('removeEvents', function (event) {
            //                                    ///if(event.start.toDateString()===new Date(Number(year), Number(month), Number(date2)).toDateString()){
            //                              alert(event.id);
            //                              if (event.id == id) {
            //                                  alert("a");
            //                                        return true;
            //                               }
            //                               })
            //                            ///}
            //                    })
            //                    var event = {
            //                        title: childSnapshot.val().title,
            //                        start: date + "T" + childSnapshot.val().start.split("T")[1],
            //                        end: date + "T" + childSnapshot.val().end.split("T")[1],
            //                        dow: [],
            //                        allday: false,
            //                        textColor: "black",
            //                        backgroundColor: "pink",
            //                        borderColor: "pink",
            //                    }
            //                    $('#calendar').fullCalendar('renderEvent', event, true);
            //                })
            //            }
            //        })
            //    });
            //}
            road();
        })
        </script>

        <script type="text/javascript">
        function init() {
            var target = document.getElementById('clock');
            target.innerHTML = new Date();
            // Window 객체는 생략이 가능하다.

            no = setInterval(setTime, 1000);                // 가능
            setInterval("setTime()", 1000);          // 가능
        }

        function setTime() {

            var target = document.getElementById('clock');
            var date = new Date();
            target.innerHTML = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate() + ' ' + date.getHours() + ':' +date.getMinutes() + ':' + date.getSeconds();

            ///target.innerHTML = date.toLocaleString();

        }

    </script>
    <style>

        body {
            margin: 40px 10px;
            padding: 0;
            font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
            font-size: 14px;
        }

        #calendar {
            color: gray;
            max-width: 900px;
            margin: 0 auto;
        }

        #dydi {
            margin-bottom: 50px;
        }
    </style>
</head>
<body onload="init();">
    <!--<div id="dydi">
        <img src="images/cat.png" width="40" height="40" style="margin-left : 40%; margin-right : 5px">
        <span style="padding-bottom : 50px; font-size : 40px; font-family : Nova Flat; font-weight : bold;">DYDI</span><span style="padding-bottom : 50px; font-size : 25px; font-weight : bold;"> Calendar</span>
        <span id="clock" style="margin-left : 11%; color : gray; font-size : 20px;"></span>
    </div>-->
   
    <div id='calendar'></div>

</body>
</html>
