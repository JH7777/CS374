<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.min.css" integrity="sha256-Tu3DN+5kwrhzlzhNUMuGht2h7cR6ARgKcYemB9u5SzA=" crossorigin="anonymous" />
    <link rel="stylesheet" media="print" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.print.min.css" integrity="sha256-wrdOlXzdxeFmQyeCnv1suX42fhtiEBrcKg1IY2cAwiI=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.1/moment.js" integrity="sha256-Z1d5nX6+IwGjjkkYg+fWe/jzvJae4NYejTz7PcIumxE=" crossorigin="anonymous"></script>
    <script src="http://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.js" integrity="sha256-uKe4jCg18Q60qLNG8dIei2y3ZVhcHADuEQFlpQ/hBRY=" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/4.10.1/firebase.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Acme" rel="stylesheet">
    <link rel="stylesheet" href="https://bootswatch.com/4/cosmo/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css?family=Francois+One" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
    <script>
        $(document).ready(function() {
            var config = {
                apiKey:"AIzaSyAn9cS4J2VMItPAG7DFDqRfgZfknrVjhQ8",
                databaseURL: "https://dydi-82330.firebaseio.com/",
            };
            firebase.initializeApp(config);

            var database = firebase.database();
            var taskRef = database.ref('task');
            var num = 0;
            var event;
            $('#calendar').fullCalendar('refetchEvents');
            $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,agendaDay,listWeek',
                },
                defaultDate: new Date(),
                navLinks: true, // can click day/week names to navigate views
                editable: true,
                eventLimit: true, // allow "more" link when too many events
                themeSystem: 'bootstrap4',
                eventMouseover: function (calEvent, jsEvent) {
                    var tooltip;
                    if (calEvent.status === "complete") {
                        tooltip = '<div class="tooltipevent" style="width:130px;height:25px;background:#fff;border-radius: 7px;border: 1px solid #777777;position:absolute;z-index:10001;">' + '&nbsp;' + '&nbsp;' + '\Completed task' + '</div>';
                    }
                    else if (calEvent.status === 'notyet') {
                        tooltip = '<div class="tooltipevent" style="width:130px;height:25px;background:#fff;border-radius: 7px;border: 1px solid #777777;position:absolute;z-index:10001;">' + '&nbsp;' + '&nbsp;' + 'Not complete yet' + '</div>';
                    }
                    else if (calEvent.status === 'notneeded') {
                        tooltip = '<div class="tooltipevent" style="width:130px;height:25px;background:#fff;border-radius: 7px;border: 1px solid #777777;position:absolute;z-index:10001;">' + '&nbsp;' + '&nbsp;' + 'Not needed task' + '</div>';
                    }
                    $("body").append(tooltip);
                    $(this).mouseover(function (e) {
                        $(this).css('z-index', 10000);
                        $('.tooltipevent').fadeIn('500');
                        $('.tooltipevent').fadeTo('10', 1.9);
                    }).mousemove(function (e) {
                        $('.tooltipevent').css('top', e.pageY + 10);
                        $('.tooltipevent').css('left', e.pageX + 20);
                    });
                },
                eventMouseout: function (calEvent, jsEvent) {
                    $(this).css('z-index', 8);
                    $('.tooltipevent').remove();
                },
                eventDrop: function (event, delta, revertFunc) {
                    var start = event.start.format().split(":")[0] + ":" + event.start.format().split(":")[1];
                    var end = event.end.format().split(":")[0] + ":" + event.end.format().split(":")[1];
                    var start2 = start.split("T")[0];
                    var end2 = end.split("T")[0];
                    if (true) {
                            ///revertFunc();
                        var newobj;
                        var group;
                        taskRef.on('value', function (snapshot) {
                            snapshot.forEach(function (childSnapshot) {
                                if (childSnapshot.val().title == event.title){
                                    group = childSnapshot.val().group;
                                }
                            })})
                            if (event.backgroundColor == "rgb(63, 159, 91)") {
                                newobj = {
                                    group: group,
                                    status: {},
                                    end: end,
                                    recurring: false,
                                    start: start,
                                    title: event.title,
                                }
                                newobj.status[start2] = true;
                                taskRef.child(String(event.id)).set(newobj);
                            }
                            else if (event.backgroundColor == "white") {
                                newobj = {
                                    group: group,
                                    status: {},
                                    end: end,
                                    recurring: false,
                                    start: start,
                                    title: event.title,
                                }
                                newobj.status[start2] = false;
                                taskRef.child(String(event.id)).set(newobj);
                                road();
                            }
                            else {
                                newobj = {
                                    group: group,
                                    end: end,
                                    recurring: false,
                                    start: start,
                                    title: event.title,
                                }
                                taskRef.child(String(event.id)).set(newobj);
                            }
                        }
                    else {
                        revertFunc();
                    }
                }
            });

            function find(a, b) {
                for (var j = 0; j < b.length; j++) {
                    if (a == b[j]){
                        return true;
                    }
                }
                return false;
            }

            function road() {
                taskRef.on('value', function (snapshot) {
                    $('#calendar').fullCalendar('removeEvents');
                    snapshot.forEach(function (childSnapshot) {
                        var range2;
                        var repeatlist = [];
                        var status = [];
                        var status2 = [];
                        var range = [];
                        var color = "white";
                        var backgroundcolor = "rgb(250,63,80)";
                        var border = "rgb(250, 63, 80)";
                        var startdate = String(childSnapshot.val().start.split("T")[0]);
                        var enddate = String(childSnapshot.val().end.split("T")[0]);
                        var starttime = String(childSnapshot.val().start.split("T")[1]);
                        var endtime = String(childSnapshot.val().end.split("T")[1]);
                        var status3 = '';
                        database.ref('task').child(childSnapshot.key).child("recurring").on('value', function (childchildsnapshot) {
                            childchildsnapshot.forEach(function(repeatsnapshot){
                                if (repeatsnapshot.val() == true) {
                                    repeatlist.push(repeatsnapshot.key);
                                }
                            })
                        });
                        database.ref('task').child(childSnapshot.key).child("status").on('value', function (childchildsnapshot) {
                            childchildsnapshot.forEach(function (repeatsnapshot) {
                                if (repeatsnapshot.val() == true) {
                                    status.push(repeatsnapshot.key);
                                }
                                else if (repeatsnapshot.val() == false) {
                                    status2.push(repeatsnapshot.key);
                                }
                            })
                        });

                        if (childSnapshot.val().recurring == false) {
                                    if (find(moment(startdate).format('YYYY-MM-DD'), status)) {
                                        backgroundcolor = "rgb(63, 159, 91)";
                                        border = "rgb(63, 159, 91)";
                                        color = "white";
                                        status3 = "notyet";
                                    }
                                    else if (find(moment(startdate).format('YYYY-MM-DD'), status2)) {
                                        backgroundcolor = "white";
                                        border = "white";
                                        color = "rgb(159, 159, 159)";
                                        status3 = "notneeded";
                                    }
                                    else {
                                        color = "white";
                                        backgroundcolor = "rgb(250, 63, 80)";
                                        border = "rgb(250, 63, 80)";
                                        status3 = "complete";
                                    }
                                    event = {
                                        title: childSnapshot.val().title,
                                        start: childSnapshot.val().start,
                                        end: childSnapshot.val().end,
                                        dow : [],
                                        allday: false,
                                        textColor: color,
                                        backgroundColor: backgroundcolor,
                                        borderColor: border,
                                        id: childSnapshot.key,
                                        status: status3,
                                    }
                                    $('#calendar').fullCalendar('renderEvent', event, true);
                        }
                        else {
                            for (var i = moment(startdate) ; i.diff(moment(enddate)) < 0 ; i = i.add(1, 'days')) {
                                if (find(i.format('d'),repeatlist)) {
                                    if (find(i.format('YYYY-MM-DD'), status)) {
                                        backgroundcolor = "rgb(63,159,91)";
                                        border = "rgb(63, 159, 91)";
                                        color = "white";
                                        status3 = "notyet";
                                    }
                                    else if (find(i.format('YYYY-MM-DD'), status2)) {
                                        backgroundcolor = "white";
                                        border = "white";
                                        color = "rgb(159, 159,159)";
                                        status3 = "notneeded";
                                    }
                                    else {
                                        color = "white";
                                        backgroundcolor = "rgb(250, 63, 80)";
                                        border = "rgb(250, 63, 80)";
                                        status3 = "complete";
                                    }
                                    event = {
                                        id: childSnapshot.key,
                                        title: childSnapshot.val().title,
                                        start: i.format('YYYY-MM-DD') + "T" + starttime,
                                        end: i.format('YYYY-MM-DD') + "T" + endtime,
                                        allday: false,
                                        textColor: color,
                                        backgroundColor: backgroundcolor,
                                        borderColor: border,
                                        editable: false,
                                        status : status3,
                                    }
                                    $('#calendar').fullCalendar('renderEvent', event, true);
                                }
                            }
                        }
                    })
                })
            }

            //function reroad() {
            //    taskRef.on('value', function (snapshot) {
            //        snapshot.forEach(function (childSnapshot) {
            //            var date;
            //            var year;
            //            var month;
            //            var date2;
            //            var id = childSnapshot.val().id;
            //            if (!(childSnapshot.val().recurring == false)) {
            //                database.ref('task').child(childSnapshot.key).child("status").on('value', function (childchildsnapshot) {
            //                    childchildsnapshot.forEach(function (repeatsnapshot) {
            //                        date = repeatsnapshot.key;
            //                        //year = date.split("-")[0];
            //                        //month = date.split("-")[1];
            //                        //date2 = date.split("-")[2];
            //                        //if (Number(month) < 10) {
            //                        //    month = month.split("0")[1];
            //                        //}
            //                        //if (Number(date2) < 10) {
            //                        //    date2 = date2.split("0")[1];
            //                        //}
            //                         $('#calendar').fullCalendar('removeEvents', function (event) {
            //                                    ///if(event.start.toDateString()===new Date(Number(year), Number(month), Number(date2)).toDateString()){
            //                              alert(event.id);
            //                              if (event.id == id) {
            //                                  alert("a");
            //                                        return true;
            //                               }
            //                               })
            //                            ///}
            //                    })
            //                    var event = {
            //                        title: childSnapshot.val().title,
            //                        start: date + "T" + childSnapshot.val().start.split("T")[1],
            //                        end: date + "T" + childSnapshot.val().end.split("T")[1],
            //                        dow: [],
            //                        allday: false,
            //                        textColor: "black",
            //                        backgroundColor: "pink",
            //                        borderColor: "pink",
            //                    }
            //                    $('#calendar').fullCalendar('renderEvent', event, true);
            //                })
            //            }
            //        })
            //    });
            //}
            road();
        })
    </script>

    <!--<script type="text/javascript">
        function init() {
            var target = document.getElementById('clock');
            target.innerHTML = new Date();
            // Window 객체는 생략이 가능하다.

            no = setInterval(setTime, 1000);                // 가능
            setInterval("setTime()", 1000);          // 가능
        }

        function setTime() {

            var target = document.getElementById('clock');
            var date = new Date();
            target.innerHTML = date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate() + ' ' + date.getHours() + ':' +date.getMinutes() + ':' + date.getSeconds();

            ///target.innerHTML = date.toLocaleString();

        }

    </script>-->
    <style>

        h2 {
            font-family: 'Francois One', sans-serif;
        }

        body {
            margin: 40px 10px;
            padding: 0;
            font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
            font-size: 14px;
        }

        #calendar {
            color: black;
            max-width: 900px;
            margin: 0 auto;
            border-color: black;
            /* font-size : 16px;
            font-family: 'Acme', sans-serif;
            font-stretch : ultra-expanded;
            border : thin; */
        }

        #dydi {
            margin-bottom: 50px;
        }
    </style>
</head>
<body style="background-color:white;">
    <!--<div id="dydi">
        <img src="images/cat.png" width="40" height="40" style="margin-left : 40%; margin-right : 5px">
        <span style="padding-bottom : 50px; font-size : 40px; font-family : Nova Flat; font-weight : bold;">DYDI</span><span style="padding-bottom : 50px; font-size : 25px; font-weight : bold;"> Calendar</span>
        <span id="clock" style="margin-left : 11%; color : gray; font-size : 20px;"></span>
    </div>-->

    <div id='calendar'></div>

</body>
</html>
